{% extends "layout.html" %}

{% block content %}

<div id="child_id" style="display:none">{{ user.id }}</div>
<div id="parent_id" style="display:none">{{ parent_id }}</div>
<div id="status" style="display:none">{{ status }}</div>

<div id="name" style="display:none">{{name}}</div>

<div class="center" style="height: 100vh;"> 
    {% set video = "videos/" + name + ".mp4" %}
    <video id="exercise-video" controls controlsList="noplaybackrate nodownload" disablePictureInPicture=true; style="padding-top: 3%; padding-bottom: 2%;">
        <source src="{{ url_for('static', filename=video) }}" type="video/mp4">
    </video>

    <br>
    
    <div style="width: 100vh; margin: 0 auto;"> 
        <form method="POST">        
            <button id="next-button" class="glow-button" disabled type="submit">
                {% if status == 2 %}
                Continue
                {% else %}
                Next
                {% endif %}
            </button>
        </form>
    </div>

</div>

<!-- Javascript controlling video to prevent cheating, e.g. via fast-forwarding video. -->
<script>
    var video=document.getElementById("exercise-video")
    
    // Enables buton on video end 
    var button_next=document.getElementById("next-button")
    var str=document.getElementById("name").innerHTML
    video.onended = function() {
        button_next.disabled = false
    }
    
    // Prevents seek
    // currTime stores the expected timestamp of the video when no seeking occurs
    var currTime = 0
    video.addEventListener("timeupdate", function() {
        if (!video.seeking) {
            currTime = video.currentTime
        }
    })
    // If user attempts to seek, the video current time is compared with the local
    // currTime and currTime is set as the current video time.
    video.addEventListener("seeking", function() {
        var diff = video.currentTime - currTime
        if (Math.abs(diff) > 0.01) {
            video.currentTime = currTime
        }
    })
    // Allows for rewatching of video
    video.addEventListener("ended", function() {
        currTime = 0
    })
    // Link to solution: https://stackoverflow.com/questions/11903545/how-to-disable-seeking-with-html5-video-tag#:~:text=You%20could%20use%20an%20HTML5%20video%20player%20like,Also%2C%20the%20event%20you%27re%20looking%20for%20is%20%27seeking%27.
</script>


<!-- Javascript that sends message stating that child has finished a stage. -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
<script type="text/javascript">
    var socket = io.connect(window.location.protocol + '//' + document.domain + ':' + location.port)

    socket.on("connect", function() {
        socket.emit( "connected", {
            data: "Child User Connected"
        } )
        $("#exercise-video").on("ended", function() {
            let child_id = document.getElementById("child_id").innerHTML
            let parent_id = document.getElementById("parent_id").innerHTML
            let status = document.getElementById("status").innerHTML
            socket.emit( "video watched", {
                child : child_id,
                parent : parent_id,
                status : status
            } )
        } )
    } )
</script>

{% endblock content %}